name: Deploy to Production

on:
  push:
    branches:
      - master
      - main
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # èŽ·å–å®Œæ•´åŽ†å²è®°å½•

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Display deployment info
        run: |
          echo "=========================================="
          echo "éƒ¨ç½²ä¿¡æ¯"
          echo "=========================================="
          echo "Commit: $(git rev-parse --short HEAD)"
          echo "Branch: ${GITHUB_REF#refs/heads/}"
          echo "Message: $(git log -1 --pretty=%B | head -1)"
          echo "Deployer: $GITHUB_ACTOR"
          echo "Time: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "=========================================="

      - name: Install dependencies
        run: |
          npm ci
          cd backend && npm ci
          cd ../frontend && npm ci

      - name: Build backend
        run: |
          cd backend
          npm run build

      - name: Build frontend
        run: |
          cd frontend
          npm run build

      - name: Run tests
        run: |
          # å¦‚æžœæœ‰æµ‹è¯•ï¼Œåœ¨è¿™é‡Œè¿è¡Œ
          # npm test
          echo "Tests would run here"

      - name: Generate deployment info
        run: |
          cat > deployment-info.json <<EOF
          {
            "deployTime": "$(date '+%Y-%m-%d %H:%M:%S')",
            "branch": "${GITHUB_REF#refs/heads/}",
            "commit": "$GITHUB_SHA",
            "commitShort": "$(git rev-parse --short HEAD)",
            "commitMessage": "$(git log -1 --pretty=%B | head -1)",
            "deployer": "$GITHUB_ACTOR",
            "nodeVersion": "$(node --version)",
            "npmVersion": "$(npm --version)",
            "workflow": "$GITHUB_WORKFLOW",
            "runNumber": "$GITHUB_RUN_NUMBER"
          }
          EOF
          cat deployment-info.json

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: deployment-artifacts
          path: |
            deployment-info.json
            backend/dist/
            frontend/dist/
          retention-days: 30

      # å¦‚æžœä½¿ç”¨ Docker
      - name: Build Docker images
        if: hashFiles('docker-compose.yml') != ''
        run: |
          docker-compose build --no-cache

      # éƒ¨ç½²æ­¥éª¤ï¼ˆæ ¹æ®å®žé™…éƒ¨ç½²æ–¹å¼é…ç½®ï¼‰
      # - name: Deploy to production
      #   run: |
      #     # SSH åˆ°ç”Ÿäº§æœåŠ¡å™¨å¹¶éƒ¨ç½²
      #     # æˆ–ä½¿ç”¨å…¶ä»–éƒ¨ç½²æ–¹å¼

      - name: Create deployment summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: \`$(git rev-parse --short HEAD)\`" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: \`${GITHUB_REF#refs/heads/}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Message**: $(git log -1 --pretty=%B | head -1)" >> $GITHUB_STEP_SUMMARY
          echo "**Time**: $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Build completed successfully" >> $GITHUB_STEP_SUMMARY
